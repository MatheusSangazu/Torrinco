services:
  server:
    build:
      context: .
      dockerfile: server/Dockerfile
    container_name: torrinco-server
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN}
      - EVOLUTION_API_URL=${EVOLUTION_API_URL}
      - EVOLUTION_API_KEY=${EVOLUTION_API_KEY}
      - EVOLUTION_INSTANCE_NAME=${EVOLUTION_INSTANCE_NAME}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - PORT=${PORT}
      - NODE_ENV=production
    healthcheck:
      test:
        - CMD-SHELL
        - node -e "fetch('http://localhost:3001/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"
      interval: 30s
      timeout: 5s
      retries: 5

  client:
    build:
      context: .
      dockerfile: client/Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL}
    container_name: torrinco-client
    depends_on:
      - server
    environment:
      - VITE_API_URL=${VITE_API_URL}
    expose:
      - "80"
    healthcheck:
      test:
        - CMD-SHELL
        - curl -f http://localhost/health || exit 1
      interval: 30s
      timeout: 5s
      retries: 5
